# File: Dockerfile.agent
FROM golang:1.24-alpine AS builder

WORKDIR /build

RUN apk add --no-cache git make

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo \
    -ldflags="-w -s" \
    -o mandau-agent \
    ./cmd/mandau-agent

# Final image
FROM alpine:3.18

RUN apk add --no-cache ca-certificates docker-cli

COPY --from=builder /build/mandau-agent /usr/local/bin/

RUN mkdir -p /var/lib/mandau/stacks /var/lib/mandau/data /var/log/mandau

EXPOSE 8443

ENTRYPOINT ["/usr/local/bin/mandau-agent"]